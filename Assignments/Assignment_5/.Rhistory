## Load Indego Trip Data (Q1 2025)
```{r load_indego}
indego <- read_csv("Data/indego-trips-2024-q4.csv")
library(tidyverse)
indego <- read_csv("Data/indego-trips-2024-q4.csv")
glimpse(indego)
colnames(indego)
library(tidyverse)
library(lubridate)
indego <- indego %>%
mutate(
# Parse datetime
start_datetime = mdy_hm(start_time),
end_datetime   = mdy_hm(end_time),
# Create hourly bins
interval60 = floor_date(start_datetime, unit = "hour"),
# Time features
week  = week(interval60),
dotw  = wday(interval60, label = TRUE),
hour  = hour(interval60),
date  = as.Date(interval60)
)
# Quick check
glimpse(indego)
trips_panel <- indego %>%
group_by(
interval60,
start_station,
start_lat,
start_lon
) %>%
summarize(
Trip_Count = n(),
.groups = "drop"
)
glimpse(trips_panel)
# How many unique stations and hours do we have?
n_stations <- length(unique(trips_panel$start_station))
n_hours    <- length(unique(trips_panel$interval60))
n_stations
n_hours
# How many rows would a complete panel have?
expected_rows <- n_stations * n_hours
expected_rows
# Build the full station-hour grid
study_panel <- expand.grid(
interval60    = sort(unique(trips_panel$interval60)),
start_station = sort(unique(trips_panel$start_station))
) %>%
# Bring in the observed trip counts + lat/lon
left_join(trips_panel, by = c("interval60", "start_station")) %>%
# Any missing Trip_Count means 0 trips in that hour at that station
mutate(
Trip_Count = replace_na(Trip_Count, 0)
)
glimpse(study_panel)
# Build station attributes (one row per station)
station_attributes <- trips_panel %>%
group_by(start_station) %>%
summarize(
start_lat = first(start_lat),
start_lon = first(start_lon),
.groups = "drop"
)
glimpse(station_attributes)
# Remove the mostly-NA lat/lon columns, then join clean ones back
study_panel <- study_panel %>%
select(-start_lat, -start_lon) %>%   # drop old ones
left_join(station_attributes, by = "start_station")
glimpse(study_panel)
study_panel <- study_panel %>%
mutate(
week    = week(interval60),
month   = month(interval60, label = TRUE),
dotw    = wday(interval60, label = TRUE),
hour    = hour(interval60),
date    = as.Date(interval60),
weekend = ifelse(dotw %in% c("Sat", "Sun"), 1, 0),
rush_hour = ifelse(hour %in% c(7, 8, 9, 16, 17, 18), 1, 0)
)
glimpse(study_panel)
library(tidyverse)
library(lubridate)
library(riem)
install.packages("riem")
library(tidyverse)
library(lubridate)
library(riem)
# Get weather from Philly airport (KPHL) for Q4 2024
weather_data <- riem_measures(
station    = "PHL",          # Philadelphia International Airport
date_start = "2024-10-01",
date_end   = "2024-12-31"
)
# Process into hourly summaries
weather_panel <- weather_data %>%
mutate(
interval60   = floor_date(valid, unit = "hour"),
Temperature  = tmpf,                      # temp in F
Precipitation = ifelse(is.na(p01i), 0, p01i),
Wind_Speed   = sknt
) %>%
select(interval60, Temperature, Precipitation, Wind_Speed) %>%
distinct()
glimpse(weather_panel)
summary(weather_panel$Temperature)
study_panel <- study_panel %>%
left_join(weather_panel, by = "interval60")
glimpse(study_panel)
study_panel <- study_panel %>%
arrange(start_station, interval60) %>%   # sort correctly
group_by(start_station) %>%
mutate(
lag1Hour   = lag(Trip_Count, 1),
lag2Hours  = lag(Trip_Count, 2),
lag3Hours  = lag(Trip_Count, 3),
lag12Hours = lag(Trip_Count, 12),
lag1day    = lag(Trip_Count, 24)
) %>%
ungroup()
glimpse(study_panel)
study_panel_complete <- study_panel %>%
filter(
!is.na(lag1Hour),
!is.na(lag2Hours),
!is.na(lag3Hours),
!is.na(lag12Hours),
!is.na(lag1day)
)
glimpse(study_panel_complete)
# Temporal train/test split for Q4 2024
train <- study_panel_complete %>%
filter(week < 50)
test <- study_panel_complete %>%
filter(week >= 50)
# Basic checks
nrow(train)
nrow(test)
min(train$date); max(train$date)
min(test$date);  max(test$date)
# In the training data: make a clean day-of-week factor
train <- train %>%
mutate(
dotw_simple = factor(
dotw,
levels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")
)
)
# Set dummy (treatment) coding for dotw_simple
contrasts(train$dotw_simple) <- contr.treatment(7)
# Quick check
table(train$dotw_simple)
model1 <- lm(
Trip_Count ~
as.factor(hour) +        # hour of day
dotw_simple +            # day of week
Temperature +
Precipitation,
data = train
)
summary(model1)
Trip_Count ~ hour + dotw_simple + Temperature + Precipitation
+ lag1Hour + lag3Hours + lag1day
