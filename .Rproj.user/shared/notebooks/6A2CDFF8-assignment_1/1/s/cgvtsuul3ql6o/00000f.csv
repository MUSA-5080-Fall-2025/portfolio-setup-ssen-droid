"0","# ---- 3.2: Tract-level demographics (robust county naming via FIPS) ----"
"0",""
"0","# 1) Variables"
"0","vars_tracts <- c("
"0","  white_nh  = ""B03002_003"",  # White alone, not Hispanic or Latino"
"0","  black_nh  = ""B03002_004"",  # Black alone, not Hispanic or Latino"
"0","  hispanic  = ""B03002_012"",  # Hispanic or Latino"
"0","  total_pop = ""B03002_001""   # Total population"
"0",")"
"0",""
"0","# 2) 3-digit county FIPS from your selected counties (5-digit GEOID -> last 3)"
"0","county_codes3 <- stringr::str_sub(selected_counties$GEOID, -3, -1) %>% unique()"
"0",""
"0","# 3) Pull ACS tract-level data"
"0","tract_raw <- tidycensus::get_acs("
"0","  geography = ""tract"","
"0","  variables = vars_tracts,"
"0","  year      = acs_year,"
"0","  survey    = ""acs5"","
"0","  state     = my_state,"
"0","  county    = county_codes3,"
"0","  output    = ""wide"""
"0",")"
"0",""
"0","# 4) Derive state/county FIPS from the tract GEOID and join to official names"
"0","#    tract GEOID = SS + CCC + TTTTTT  (state 2, county 3, tract 6)"
"0","tract_demo <- tract_raw %>%"
"0","  dplyr::mutate("
"0","    state_fips  = stringr::str_sub(GEOID, 1, 2),"
"0","    county_fips = stringr::str_sub(GEOID, 3, 5),"
"0","    tract_label = stringr::str_extract(NAME, ""^Census Tract\\s*[^,]+"") %>%"
"0","                  stringr::str_remove(""^Census Tract\\s*"")"
"0","  ) %>%"
"0","  dplyr::left_join("
"0","    tidycensus::fips_codes %>%"
"0","      dplyr::transmute("
"0","        state_fips  = state_code,"
"0","        county_fips = county_code,"
"0","        county_label = county,   # e.g., ""Kings"""
"0","        state_label  = state     # e.g., ""New York"""
"0","      ),"
"0","    by = c(""state_fips"", ""county_fips"")"
"0","  ) %>%"
"0","  # 5) Compute percentages"
"0","  dplyr::mutate("
"0","    pct_white_nh = dplyr::if_else(total_popE > 0, 100 * white_nhE / total_popE, NA_real_),"
"0","    pct_black_nh = dplyr::if_else(total_popE > 0, 100 * black_nhE / total_popE, NA_real_),"
"0","    pct_hispanic = dplyr::if_else(total_popE > 0, 100 * hispanicE / total_popE, NA_real_)"
"0","  )"
"0",""
"0","# Quick peek"
"0","knitr::kable("
"0","  tract_demo %>%"
"0","    dplyr::select("
"0","      GEOID, tract_label, county_label,"
"0","      total_popE, white_nhE, pct_white_nh,"
"0","      black_nhE, pct_black_nh,"
"0","      hispanicE, pct_hispanic"
"0","    ) %>% head(10),"
"0","  caption = ""Tract demographics with population percentages (first 10 rows)"","
"0","  digits = 1"
"0",")"
