{
  "hash": "019f9b7cb75fe9fde8ef0014d5a8395c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Week 4 In-Class Practice Exercises\"\nsubtitle: \"Spatial Operations with Pennsylvania Data\"\nauthor: \"Your Name Here\"\ndate: today\nformat: \n  html:\n    code-fold: false\n    toc: true\n    toc-location: left\n    theme: cosmo\nexecute:\n  warning: false\n  message: false\n---\n\n## Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sf)\nlibrary(tidyverse)\nlibrary(tigris)\nlibrary(tidycensus)\nlibrary(scales)\nlibrary(patchwork)\nlibrary(here)\n# Set Census API key\ncensus_api_key(\"42bf8a20a3df1def380f330cf7edad0dd5842ce6\")\n\n# Load the data (same as lecture)\npa_counties <- st_read(here(\"data/Pennsylvania_County_Boundaries.shp\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `Pennsylvania_County_Boundaries' from data source \n  `C:\\Users\\16468\\OneDrive - PennO365\\Documents\\Academics\\MUSA\\Public_Policy_Analytics\\portfolio-setup-ssen-droid\\Labs\\Week 4\\week-04\\data\\Pennsylvania_County_Boundaries.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 67 features and 19 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -8963377 ymin: 4825316 xmax: -8314404 ymax: 5201413\nProjected CRS: WGS 84 / Pseudo-Mercator\n```\n\n\n:::\n\n```{.r .cell-code}\ndistricts <- st_read(here(\"data/districts.geojson\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `U.S._Congressional_Districts_for_Pennsylvania' from data source \n  `C:\\Users\\16468\\OneDrive - PennO365\\Documents\\Academics\\MUSA\\Public_Policy_Analytics\\portfolio-setup-ssen-droid\\Labs\\Week 4\\week-04\\data\\districts.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 17 features and 8 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -80.51939 ymin: 39.71986 xmax: -74.68956 ymax: 42.26935\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\nhospitals <- st_read(here(\"data/hospitals.geojson\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `hospitals' from data source \n  `C:\\Users\\16468\\OneDrive - PennO365\\Documents\\Academics\\MUSA\\Public_Policy_Analytics\\portfolio-setup-ssen-droid\\Labs\\Week 4\\week-04\\data\\hospitals.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 223 features and 11 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -80.49621 ymin: 39.75163 xmax: -74.86704 ymax: 42.13403\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\ncensus_tracts <- tracts(state = \"PA\", cb = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  |                                                                            \n  |                                                                      |   0%\n  |                                                                            \n  |=                                                                     |   2%\n  |                                                                            \n  |==                                                                    |   2%\n  |                                                                            \n  |==                                                                    |   3%\n  |                                                                            \n  |===                                                                   |   4%\n  |                                                                            \n  |====                                                                  |   5%\n  |                                                                            \n  |====                                                                  |   6%\n  |                                                                            \n  |=====                                                                 |   7%\n  |                                                                            \n  |=====                                                                 |   8%\n  |                                                                            \n  |======                                                                |   9%\n  |                                                                            \n  |=======                                                               |  10%\n  |                                                                            \n  |=======                                                               |  11%\n  |                                                                            \n  |========                                                              |  12%\n  |                                                                            \n  |=========                                                             |  13%\n  |                                                                            \n  |==========                                                            |  14%\n  |                                                                            \n  |==========                                                            |  15%\n  |                                                                            \n  |===========                                                           |  16%\n  |                                                                            \n  |============                                                          |  17%\n  |                                                                            \n  |============                                                          |  18%\n  |                                                                            \n  |=============                                                         |  19%\n  |                                                                            \n  |==============                                                        |  20%\n  |                                                                            \n  |===============                                                       |  21%\n  |                                                                            \n  |===============                                                       |  22%\n  |                                                                            \n  |================                                                      |  23%\n  |                                                                            \n  |=================                                                     |  24%\n  |                                                                            \n  |=================                                                     |  25%\n  |                                                                            \n  |==================                                                    |  26%\n  |                                                                            \n  |===================                                                   |  27%\n  |                                                                            \n  |===================                                                   |  28%\n  |                                                                            \n  |====================                                                  |  29%\n  |                                                                            \n  |=====================                                                 |  30%\n  |                                                                            \n  |=====================                                                 |  31%\n  |                                                                            \n  |======================                                                |  31%\n  |                                                                            \n  |=======================                                               |  32%\n  |                                                                            \n  |=======================                                               |  33%\n  |                                                                            \n  |========================                                              |  34%\n  |                                                                            \n  |=========================                                             |  35%\n  |                                                                            \n  |=========================                                             |  36%\n  |                                                                            \n  |==========================                                            |  37%\n  |                                                                            \n  |===========================                                           |  38%\n  |                                                                            \n  |============================                                          |  39%\n  |                                                                            \n  |============================                                          |  40%\n  |                                                                            \n  |=============================                                         |  41%\n  |                                                                            \n  |==============================                                        |  42%\n  |                                                                            \n  |==============================                                        |  43%\n  |                                                                            \n  |===============================                                       |  44%\n  |                                                                            \n  |================================                                      |  45%\n  |                                                                            \n  |================================                                      |  46%\n  |                                                                            \n  |=================================                                     |  47%\n  |                                                                            \n  |==================================                                    |  48%\n  |                                                                            \n  |==================================                                    |  49%\n  |                                                                            \n  |===================================                                   |  50%\n  |                                                                            \n  |====================================                                  |  51%\n  |                                                                            \n  |====================================                                  |  52%\n  |                                                                            \n  |=====================================                                 |  53%\n  |                                                                            \n  |======================================                                |  54%\n  |                                                                            \n  |======================================                                |  55%\n  |                                                                            \n  |=======================================                               |  56%\n  |                                                                            \n  |========================================                              |  57%\n  |                                                                            \n  |========================================                              |  58%\n  |                                                                            \n  |=========================================                             |  59%\n  |                                                                            \n  |==========================================                            |  60%\n  |                                                                            \n  |===========================================                           |  61%\n  |                                                                            \n  |===========================================                           |  62%\n  |                                                                            \n  |============================================                          |  63%\n  |                                                                            \n  |=============================================                         |  64%\n  |                                                                            \n  |=============================================                         |  65%\n  |                                                                            \n  |==============================================                        |  66%\n  |                                                                            \n  |===============================================                       |  67%\n  |                                                                            \n  |===============================================                       |  68%\n  |                                                                            \n  |================================================                      |  69%\n  |                                                                            \n  |=================================================                     |  70%\n  |                                                                            \n  |=================================================                     |  71%\n  |                                                                            \n  |==================================================                    |  71%\n  |                                                                            \n  |===================================================                   |  72%\n  |                                                                            \n  |===================================================                   |  73%\n  |                                                                            \n  |====================================================                  |  74%\n  |                                                                            \n  |=====================================================                 |  75%\n  |                                                                            \n  |=====================================================                 |  76%\n  |                                                                            \n  |======================================================                |  77%\n  |                                                                            \n  |=======================================================               |  78%\n  |                                                                            \n  |=======================================================               |  79%\n  |                                                                            \n  |========================================================              |  80%\n  |                                                                            \n  |=========================================================             |  81%\n  |                                                                            \n  |==========================================================            |  82%\n  |                                                                            \n  |==========================================================            |  83%\n  |                                                                            \n  |===========================================================           |  84%\n  |                                                                            \n  |============================================================          |  85%\n  |                                                                            \n  |============================================================          |  86%\n  |                                                                            \n  |=============================================================         |  87%\n  |                                                                            \n  |==============================================================        |  88%\n  |                                                                            \n  |==============================================================        |  89%\n  |                                                                            \n  |===============================================================       |  90%\n  |                                                                            \n  |================================================================      |  91%\n  |                                                                            \n  |================================================================      |  92%\n  |                                                                            \n  |=================================================================     |  93%\n  |                                                                            \n  |==================================================================    |  94%\n  |                                                                            \n  |==================================================================    |  95%\n  |                                                                            \n  |===================================================================   |  96%\n  |                                                                            \n  |====================================================================  |  97%\n  |                                                                            \n  |====================================================================  |  98%\n  |                                                                            \n  |===================================================================== |  99%\n  |                                                                            \n  |======================================================================| 100%\n```\n\n\n:::\n\n```{.r .cell-code}\nmetro_areas <- core_based_statistical_areas(cb = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  |                                                                            \n  |                                                                      |   0%\n  |                                                                            \n  |======================================================================| 100%\n```\n\n\n:::\n\n```{.r .cell-code}\n# Standardize CRS\nhospitals <- st_transform(hospitals, st_crs(pa_counties))\ncensus_tracts <- st_transform(census_tracts, st_crs(pa_counties))\nmetro_areas <- st_transform(metro_areas, st_crs(pa_counties))\ndistricts <- st_transform(districts, st_crs(census_tracts))\n```\n:::\n\n\n---\n\n## Exercise 1: Find Your County's Neighbors (10 minutes)\n\n**Goal:** Practice spatial filtering with different predicates\n\n### 1.1 Pick a Pennsylvania County\n\n**Your Task:** Choose any PA county and find all counties that border it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 1: Look at available county names\nunique(pa_counties$COUNTY_NAM)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"MONTGOMERY\"     \"BRADFORD\"       \"BUCKS\"          \"TIOGA\"         \n [5] \"UNION\"          \"VENANGO\"        \"WASHINGTON\"     \"WAYNE\"         \n [9] \"MCKEAN\"         \"MERCER\"         \"MIFFLIN\"        \"MONTOUR\"       \n[13] \"NORTHAMPTON\"    \"NORTHUMBERLAND\" \"PERRY\"          \"PIKE\"          \n[17] \"POTTER\"         \"SCHUYLKILL\"     \"SNYDER\"         \"SOMERSET\"      \n[21] \"SULLIVAN\"       \"LEBANON\"        \"BUTLER\"         \"CAMBRIA\"       \n[25] \"CAMERON\"        \"CARBON\"         \"CENTRE\"         \"CLARION\"       \n[29] \"CLEARFIELD\"     \"CLINTON\"        \"COLUMBIA\"       \"CRAWFORD\"      \n[33] \"CUMBERLAND\"     \"DAUPHIN\"        \"INDIANA\"        \"JEFFERSON\"     \n[37] \"JUNIATA\"        \"LANCASTER\"      \"WESTMORELAND\"   \"WYOMING\"       \n[41] \"YORK\"           \"PHILADELPHIA\"   \"LEHIGH\"         \"LUZERNE\"       \n[45] \"LYCOMING\"       \"LAWRENCE\"       \"DELAWARE\"       \"ELK\"           \n[49] \"ERIE\"           \"FAYETTE\"        \"FOREST\"         \"FRANKLIN\"      \n[53] \"FULTON\"         \"GREENE\"         \"HUNTINGDON\"     \"ADAMS\"         \n[57] \"ALLEGHENY\"      \"ARMSTRONG\"      \"BEAVER\"         \"BEDFORD\"       \n[61] \"BLAIR\"          \"SUSQUEHANNA\"    \"WARREN\"         \"BERKS\"         \n[65] \"CHESTER\"        \"MONROE\"         \"LACKAWANNA\"    \n```\n\n\n:::\n\n```{.r .cell-code}\n# Step 2: Pick one county (change this to your choice!)\nmy_county <- pa_counties %>%\n  filter(COUNTY_NAM == \"CENTRE\")  # Change \"CENTRE\" to your county\n\n# Step 3: Find neighbors using st_touches\nmy_neighbors <- pa_counties %>%\n  st_filter(my_county, .predicate = st_touches)\n\n# Step 4: How many neighbors does your county have?\ncat(\"Number of neighboring counties:\", nrow(my_neighbors), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNumber of neighboring counties: 6 \n```\n\n\n:::\n\n```{.r .cell-code}\nprint(\"Neighbor names:\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Neighbor names:\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(my_neighbors$COUNTY_NAM)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"UNION\"      \"MIFFLIN\"    \"CLEARFIELD\" \"CLINTON\"    \"HUNTINGDON\"\n[6] \"BLAIR\"     \n```\n\n\n:::\n:::\n\n\n### 1.2 Map Your Results\n\n**Your Task:** Create a map showing your county and its neighbors in different colors.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create the map\nggplot() +\n  geom_sf(data = pa_counties, fill = \"lightgray\", color = \"white\") +\n  geom_sf(data = my_neighbors, fill = \"lightblue\", alpha = 0.7) +\n  geom_sf(data = my_county, fill = \"darkblue\") +\n  labs(\n    title = paste(\"Neighbors of\", my_county$COUNTY_NAM[1], \"County\"),\n    subtitle = paste(nrow(my_neighbors), \"neighboring counties\")\n  ) +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](week4_inclass_practice_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n### 1.3 Challenge: Compare with st_intersects\n\n**Your Task:** What happens if you use `st_intersects` instead of `st_touches`? Why is the count different?\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Use st_intersects\nintersecting_counties <- pa_counties %>%\n  st_filter(my_county, .predicate = st_intersects)\n\ncat(\"With st_touches:\", nrow(my_neighbors), \"counties\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nWith st_touches: 6 counties\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"With st_intersects:\", nrow(intersecting_counties), \"counties\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nWith st_intersects: 7 counties\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Difference:\", nrow(intersecting_counties) - nrow(my_neighbors), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDifference: 1 \n```\n\n\n:::\n:::\n\n\n**Question:** Why is there a difference of 1? What does this tell you about the difference between `st_touches` and `st_intersects`?\n\n---\n\n## Exercise 2: Hospital Service Areas (15 minutes)\n\n**Goal:** Practice buffering and measuring accessibility\n\n### 2.1 Create Hospital Service Areas\n\n**Your Task:** Create 15-mile (24140 meter) service areas around all hospitals in your county.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 1: Filter hospitals in your county\n# First do a spatial join to assign counties to hospitals\nhospitals_with_county <- hospitals %>%\n  st_join(pa_counties %>% select(COUNTY_NAM))\n\n# Filter for your county's hospitals\nmy_county_hospitals <- hospitals_with_county %>%\n  filter(COUNTY_NAM == \"CENTRE\")  # Change to match your county\n\ncat(\"Number of hospitals in county:\", nrow(my_county_hospitals), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNumber of hospitals in county: 3 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Step 2: Project to accurate CRS for buffering\nmy_county_hospitals_proj <- my_county_hospitals %>%\n  st_transform(3365)  # Pennsylvania State Plane South\n\n# Step 3: Create 15-mile buffers (24140 meters = 15 miles)\nhospital_service_areas <- my_county_hospitals_proj %>%\n  st_buffer(dist = 79200)  # 15 miles in feet for PA State Plane\n\n# Step 4: Transform back for mapping\nhospital_service_areas <- st_transform(hospital_service_areas, st_crs(pa_counties))\n```\n:::\n\n\n### 2.2 Map Service Coverage\n\n**Your Task:** Create a map showing hospitals and their service areas.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = my_county, fill = \"white\", color = \"gray\") +\n  geom_sf(data = hospital_service_areas, fill = \"lightblue\", alpha = 0.4) +\n  geom_sf(data = my_county_hospitals, color = \"red\", size = 2) +\n  labs(\n    title = paste(\"Hospital Service Areas in\", my_county$COUNTY_NAM[1], \"County\"),\n    subtitle = \"Red points = Hospitals, Blue areas = 15-mile service zones\"\n  ) +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](week4_inclass_practice_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n### 2.3 Calculate Coverage\n\n**Your Task:** What percentage of your county is within 15 miles of a hospital?\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Union all service areas into one polygon\ncombined_service_area <- hospital_service_areas %>%\n  st_union()\n\n# Calculate areas (need to be in projected CRS)\nmy_county_proj <- st_transform(my_county, 3365)\ncombined_service_proj <- st_transform(combined_service_area, 3365)\n\n# Find intersection\ncoverage_area <- st_intersection(my_county_proj, combined_service_proj)\n\n# Calculate percentages\ncounty_area <- as.numeric(st_area(my_county_proj))\ncovered_area <- as.numeric(st_area(coverage_area))\ncoverage_pct <- (covered_area / county_area) * 100\n\ncat(\"County area:\", round(county_area / 1e6, 1), \"sq km\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCounty area: 30993.6 sq km\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Covered area:\", round(covered_area / 1e6, 1), \"sq km\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCovered area: 19205.1 sq km\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Coverage:\", round(coverage_pct, 1), \"%\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCoverage: 62 %\n```\n\n\n:::\n:::\n\n\n**Question:** Is your county well-served by hospitals? What areas might be underserved?\n\n---\n\n## Exercise 3: Congressional District Analysis (15 minutes)\n\n**Goal:** Practice spatial joins and aggregation\n\n### 4.1 Join Districts to Counties\n\n**Your Task:** Figure out which congressional districts overlap with each county.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Spatial join: districts to counties\ndistricts_by_county <- districts %>%\n  st_join(pa_counties %>% select(COUNTY_NAM)) %>%\n  st_drop_geometry() %>%\n  group_by(COUNTY_NAM) %>%\n  summarize(\n    n_districts = n_distinct(OBJECTID),\n    district_ids = paste(unique(MSLINK), collapse = \", \")\n  ) %>%\n  arrange(desc(n_districts))\n\n# Which counties have the most districts?\nhead(districts_by_county, 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 3\n   COUNTY_NAM   n_districts district_ids            \n   <chr>              <int> <chr>                   \n 1 MONTGOMERY             7 19, 2, 14, 20, 4, 15, 21\n 2 BERKS                  6 8, 19, 2, 14, 4, 5      \n 3 ALLEGHENY              5 11, 12, 17, 1, 7        \n 4 PHILADELPHIA           5 19, 14, 20, 15, 21      \n 5 WESTMORELAND           5 11, 12, 17, 3, 7        \n 6 BUCKS                  4 19, 2, 14, 20           \n 7 CHESTER                4 14, 4, 5, 15            \n 8 DAUPHIN                4 8, 3, 5, 6              \n 9 JUNIATA                4 8, 12, 3, 6             \n10 LANCASTER              4 8, 4, 5, 6              \n```\n\n\n:::\n:::\n\n\n\n### 4.2 Calculate District Statistics\n\n**Your Task:** Get demographic data for census tracts and aggregate to districts.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get tract-level demographics\ntract_demographics <- get_acs(\n  geography = \"tract\",\n  variables = c(\n    total_pop = \"B01003_001\",\n    median_income = \"B19013_001\",\n    white_pop = \"B03002_003\",\n    black_pop = \"B03002_004\",\n    hispanic_pop = \"B03002_012\"\n  ),\n  state = \"PA\",\n  year = 2022,\n  output = \"wide\"\n)\n\n# Join to tract boundaries\ntracts_with_data <- census_tracts %>%\n  left_join(tract_demographics, by = \"GEOID\")\n\n# Spatial join to districts and aggregate\ndistrict_demographics <- tracts_with_data %>%\n  st_join(districts) %>%\n  st_drop_geometry() %>%\n  group_by(OBJECTID, MSLINK) %>%\n  summarize(\n    total_population = sum(total_popE, na.rm = TRUE),\n    median_income = weighted.mean(median_incomeE, total_popE, na.rm = TRUE),\n    pct_white = sum(white_popE, na.rm = TRUE) / sum(total_popE, na.rm = TRUE) * 100,\n    pct_black = sum(black_popE, na.rm = TRUE) / sum(total_popE, na.rm = TRUE) * 100,\n    pct_hispanic = sum(hispanic_popE, na.rm = TRUE) / sum(total_popE, na.rm = TRUE) * 100,\n    n_tracts = n()\n  ) %>%\n  arrange(desc(total_population))\n\n# Show results\nhead(district_demographics, 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 8\n# Groups:   OBJECTID [10]\n   OBJECTID MSLINK total_population median_income pct_white pct_black\n      <int>  <int>            <dbl>         <dbl>     <dbl>     <dbl>\n 1      113     14          1229246       107602.      72.0     11.0 \n 2      108     11          1010001        76612.      76.6     13.4 \n 3      120      7          1006212        88796.      83.3      8.15\n 4      107      8           993966        70241.      88.7      2.24\n 5      117      3           986114        69017.      91.0      2.25\n 6      109     12           979419        63952.      92.2      1.81\n 7      118      4           974715       111250.      73.0      5.00\n 8      114     17           972225        71139.      91.8      2.75\n 9      110     19           932212       113798.      80.7      3.79\n10      123      6           927718        80080.      75.6      8.65\n# ℹ 2 more variables: pct_hispanic <dbl>, n_tracts <int>\n```\n\n\n:::\n:::\n\n\n### 4.3 Map District Demographics\n\n**Your Task:** Create a choropleth map of median income by congressional district.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Join demographics back to district boundaries\ndistricts_with_demographics <- districts %>%\n  left_join(district_demographics, by = \"OBJECTID\")\n\n# Create the map\nggplot(districts_with_demographics) +\n  geom_sf(aes(fill = median_income), color = \"white\", size = 0.5) +\n  scale_fill_viridis_c(\n    name = \"Median\\nIncome\",\n    labels = dollar,\n    option = \"plasma\"\n  ) +\n  labs(\n    title = \"Median Household Income by Congressional District\",\n    subtitle = \"Pennsylvania\",\n    caption = \"Source: ACS 2018-2022\"\n  ) +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](week4_inclass_practice_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n### 4.4 Challenge: Find Diverse Districts\n\n**Your Task:** Which districts are the most racially diverse?\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate diversity index (simple version: higher = more diverse)\n# A perfectly even distribution would be ~33% each for 3 groups\ndistrict_demographics <- district_demographics %>%\n  mutate(\n    diversity_score = 100 - abs(pct_white - 33.3) - abs(pct_black - 33.3) - abs(pct_hispanic - 33.3)\n  ) %>%\n  arrange(desc(diversity_score))\n\n# Most diverse districts\nhead(district_demographics %>% select(MSLINK, pct_white, pct_black, pct_hispanic, diversity_score), 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 6\n# Groups:   OBJECTID [5]\n  OBJECTID MSLINK pct_white pct_black pct_hispanic diversity_score\n     <int>  <int>     <dbl>     <dbl>        <dbl>           <dbl>\n1      115     20      37.9     25.4         23.7             77.8\n2      122     21      33.5     49.7          5.73            55.9\n3      121     15      58.8     24.4          5.77            38.1\n4      111      2      71.2      4.88        18.3             18.7\n5      113     14      72.0     11.0          7.09            12.8\n```\n\n\n:::\n\n```{.r .cell-code}\n# Least diverse districts\ntail(district_demographics %>% select(MSLINK, pct_white, pct_black, pct_hispanic, diversity_score), 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 6\n# Groups:   OBJECTID [5]\n  OBJECTID MSLINK pct_white pct_black pct_hispanic diversity_score\n     <int>  <int>     <dbl>     <dbl>        <dbl>           <dbl>\n1      107      8      88.7      2.24         5.73           -14.1\n2      116      1      89.3      3.66         2.53           -16.4\n3      117      3      91.0      2.25         3.24           -18.8\n4      114     17      91.8      2.75         1.49           -20.9\n5      109     12      92.2      1.81         2.09           -21.6\n```\n\n\n:::\n:::\n\n\n---\n\n## Exercise 5: Projection Effects (10 minutes)\n\n**Goal:** Understand how CRS affects calculations\n\n### 5.1 Calculate Areas in Different Projections\n\n**Your Task:** Calculate county areas using different coordinate systems and compare.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate areas in different CRS\narea_comparison <- pa_counties %>%\n  # Geographic (WGS84) - WRONG for areas!\n  st_transform(4326) %>%\n  mutate(area_geographic = as.numeric(st_area(.))) %>%\n  # PA State Plane South - Good for PA\n  st_transform(3365) %>%\n  mutate(area_state_plane = as.numeric(st_area(.))) %>%\n  # Albers Equal Area - Good for areas\n  st_transform(5070) %>%\n  mutate(area_albers = as.numeric(st_area(.))) %>%\n  st_drop_geometry() %>%\n  select(COUNTY_NAM, starts_with(\"area_\")) %>%\n  mutate(\n    # Calculate errors compared to Albers (most accurate for area)\n    error_geographic_pct = abs(area_geographic - area_albers) / area_albers * 100,\n    error_state_plane_pct = abs(area_state_plane - area_albers) / area_state_plane * 100\n  )\n\n# Show counties with biggest errors\narea_comparison %>%\n  arrange(desc(error_geographic_pct)) %>%\n  select(COUNTY_NAM, error_geographic_pct, error_state_plane_pct) %>%\n  head(10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    COUNTY_NAM error_geographic_pct error_state_plane_pct\n1         ERIE            0.1520567              90.71567\n2  SUSQUEHANNA            0.1480129              90.71426\n3       MCKEAN            0.1479719              90.71414\n4       WARREN            0.1478826              90.71421\n5     BRADFORD            0.1473177              90.71402\n6        TIOGA            0.1469541              90.71390\n7       POTTER            0.1463317              90.71371\n8     CRAWFORD            0.1447572              90.71326\n9        WAYNE            0.1440222              90.71306\n10     WYOMING            0.1409741              90.71215\n```\n\n\n:::\n:::\n\n\n### 5.2 Visualize the Error\n\n**Your Task:** Map which counties have the biggest area calculation errors.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Join error data back to counties\ncounties_with_errors <- pa_counties %>%\n  left_join(\n    area_comparison %>% select(COUNTY_NAM, error_geographic_pct),\n    by = \"COUNTY_NAM\"\n  )\n\n# Map the error\nggplot(counties_with_errors) +\n  geom_sf(aes(fill = error_geographic_pct), color = \"white\") +\n  scale_fill_viridis_c(\n    name = \"Area\\nError %\",\n    option = \"magma\"\n  ) +\n  labs(\n    title = \"Area Calculation Errors by County\",\n    subtitle = \"Using geographic coordinates (WGS84) instead of projected CRS\"\n  ) +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](week4_inclass_practice_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n**Question:** Which counties have the largest errors? Why might this be?\n\n---\n\n## Bonus Challenge: Combined Analysis (If Time Permits)\n\n**Goal:** Combine multiple operations for a complex policy question\n\n### Research Question\n\n**Which Pennsylvania counties have the highest proportion of vulnerable populations (elderly + low-income) living far from hospitals?**\n\n**Your Task:** Combine what you've learned to identify vulnerable, underserved communities.\n\n**Steps:**\n1. Get demographic (elderly and income) data for census tracts\n2. Identify vulnerable tracts (low income AND high elderly population)\n3. Calculate distance to nearest hospital\n4. Check which ones are more than 15 miles from a hospital\n5. Aggregate to county level\n6. Create comprehensive map\n7. Create a summary table\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Your code here!\n```\n:::\n\n\n\n---\n\n## Reflection Questions\n\nAfter completing these exercises, reflect on:\n\n1. **When did you need to transform CRS?** Why was this necessary?\n\n2. **What's the difference between `st_filter()` and `st_intersection()`?** When would you use each?\n\n3. **How does the choice of predicate (st_touches, st_intersects, st_within) change your results?**\n\n\n---\n\n## Summary of Key Functions Used\n\n| Function | Purpose | Example Use |\n|----------|---------|-------------|\n| `st_filter()` | Select features by spatial relationship | Find neighboring counties |\n| `st_buffer()` | Create zones around features | Hospital service areas |\n| `st_intersects()` | Test spatial overlap | Check access to services |\n| `st_disjoint()` | Test spatial separation | Find rural areas |\n| `st_join()` | Join by location | Add county info to tracts |\n| `st_union()` | Combine geometries | Merge overlapping buffers |\n| `st_intersection()` | Clip geometries | Calculate overlap areas |\n| `st_transform()` | Change CRS | Accurate distance/area calculations |\n| `st_area()` | Calculate areas | County sizes, coverage |\n| `st_distance()` | Calculate distances | Distance to facilities |\n\n**Important Reminder:** Always *check* and standardize CRS when working with spatial data from multiple sources!",
    "supporting": [
      "week4_inclass_practice_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}